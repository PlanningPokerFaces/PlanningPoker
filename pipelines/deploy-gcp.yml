docker-build-push-gcp:
  image: docker:dind
  stage: docker-build
  tags:
    - docker
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH      # Run for all changes to the default branch only
  variables:
    VER: 1.0-${CI_PIPELINE_ID}
    ID: ${CI_COMMIT_SHORT_SHA}
    GIT_SUBMODULE_STRATEGY: recursive
  before_script:
    - cat $GCP_CLOUD_BUILD_SERVICE_KEY_FILE | docker login -u _json_key --password-stdin $GCP_URL
    - docker info
  timeout: 1h
  services:
    - docker:dind
  script:
    - echo Image name ${GCP_IMAGE_NAME}{$CI_COMMIT_SHA}
    - docker build -t $GCP_IMAGE_NAME -f $PATH_DOCKERFILE .
    - docker push $GCP_IMAGE_NAME
      
redeploy-latest-gcp:
  stage: deploy
  image: google/cloud-sdk:alpine
  environment: PROD
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH      # Run for all changes to the default branch only
  variables:
  before_script:
    - echo $GCP_CLOUD_BUILD_SERVICE_KEY > /tmp/gcloud-service-key.json
  script:
    - gcloud auth activate-service-account --key-file /tmp/gcloud-service-key.json
    - gcloud run deploy $GCP_DEPLOY_SERVICENAME --project $GCP_PROJECT --region $GCP_DEPLOY_REGION --image ${GCP_IMAGE_NAME}:latest